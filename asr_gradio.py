import gradio as gr
import os
import tempfile
import logging
from pathlib import Path
from typing import List, Optional
import json
import time
from BcutASR import BcutASR

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)

class ASRGradioApp:
    def __init__(self):
        self.supported_formats = ['.mp3', '.wav', '.m4a', '.flac', '.aac', '.mp4', '.avi', '.mov', '.mkv']
        
    def process_single_file(self, file_path: str, output_format: str) -> tuple:
        """å¤„ç†å•ä¸ªæ–‡ä»¶ï¼Œè¿”å›å¤„ç†ç»“æœå’Œæ–‡ä»¶è·¯å¾„"""
        try:
            logging.info(f"å¼€å§‹å¤„ç†æ–‡ä»¶: {file_path}")
            
            # ä½¿ç”¨BcutASRè¿›è¡Œè¯­éŸ³è¯†åˆ«
            asr = BcutASR(file_path)
            asr_data = asr.run()
            
            # ç”Ÿæˆè¾“å‡ºæ–‡ä»¶è·¯å¾„
            input_path = Path(file_path)
            output_path = input_path.with_suffix(f'.{output_format.lower()}')
            
            # æ ¹æ®æ ¼å¼ç”Ÿæˆè¾“å‡ºå†…å®¹
            if output_format.upper() == 'SRT':
                content = self._generate_srt(asr_data)
            elif output_format.upper() == 'TXT':
                content = self._generate_txt(asr_data)
            elif output_format.upper() == 'ASS':
                content = self._generate_ass(asr_data)
            else:
                content = self._generate_txt(asr_data)
            
            # å†™å…¥æ–‡ä»¶
            with open(output_path, 'w', encoding='utf-8') as f:
                f.write(content)
            
            logging.info(f"å¤„ç†å®Œæˆ: {output_path}")
            return f"å¤„ç†æˆåŠŸï¼è¾“å‡ºæ–‡ä»¶: {output_path}", str(output_path)
            
        except Exception as e:
            logging.error(f"å¤„ç†æ–‡ä»¶å¤±è´¥: {str(e)}")
            return f"å¤„ç†å¤±è´¥: {str(e)}", None
    
    def process_multiple_files(self, files: List[str], output_format: str) -> str:
        """å¤„ç†å¤šä¸ªæ–‡ä»¶"""
        results = []
        total_files = len(files)
        
        for i, file_path in enumerate(files, 1):
            logging.info(f"å¤„ç†æ–‡ä»¶ {i}/{total_files}: {file_path}")
            try:
                result = self.process_single_file(file_path, output_format)
                results.append(f"{i}. {file_path}: {result}")
            except Exception as e:
                results.append(f"{i}. {file_path}: å¤„ç†å¤±è´¥ - {str(e)}")
        
        return "\n".join(results)
    
    def _generate_srt(self, asr_data) -> str:
        """ç”ŸæˆSRTå­—å¹•æ ¼å¼"""
        srt_content = []
        for i, segment in enumerate(asr_data.segments, 1):
            start_time = self._format_timestamp(segment.start)
            end_time = self._format_timestamp(segment.end)
            srt_content.append(f"{i}\n{start_time} --> {end_time}\n{segment.text}\n")
        return "\n".join(srt_content)
    
    def _generate_txt(self, asr_data) -> str:
        """ç”ŸæˆTXTæ–‡æœ¬æ ¼å¼"""
        return "\n".join([segment.text for segment in asr_data.segments])
    
    def _generate_ass(self, asr_data) -> str:
        """ç”ŸæˆASSå­—å¹•æ ¼å¼"""
        ass_header = """[Script Info]
Title: Generated by ASR Tools
ScriptType: v4.00+
Collisions: Normal
PlayDepth: 0

[V4+ Styles]
Format: Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut, ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV, Encoding
Style: Default,Arial,20,&H00FFFFFF,&H000000FF,&H00000000,&H00000000,0,0,0,0,100,100,0,0,1,2,0,2,10,10,10,1

[Events]
Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text
"""
        
        ass_events = []
        for segment in asr_data.segments:
            start_time = self._format_ass_timestamp(segment.start)
            end_time = self._format_ass_timestamp(segment.end)
            ass_events.append(f"Dialogue: 0,{start_time},{end_time},Default,,0,0,0,,{segment.text}")
        
        return ass_header + "\n".join(ass_events)
    
    def _format_timestamp(self, seconds: float) -> str:
        """æ ¼å¼åŒ–æ—¶é—´æˆ³ä¸ºSRTæ ¼å¼"""
        hours = int(seconds // 3600)
        minutes = int((seconds % 3600) // 60)
        secs = int(seconds % 60)
        millis = int((seconds - int(seconds)) * 1000)
        return f"{hours:02d}:{minutes:02d}:{secs:02d},{millis:03d}"
    
    def _format_ass_timestamp(self, seconds: float) -> str:
        """æ ¼å¼åŒ–æ—¶é—´æˆ³ä¸ºASSæ ¼å¼"""
        hours = int(seconds // 3600)
        minutes = int((seconds % 3600) // 60)
        secs = int(seconds % 60)
        centisecs = int((seconds - int(seconds)) * 100)
        return f"{hours}:{minutes:02d}:{secs:02d}.{centisecs:02d}"

def create_interface():
    """åˆ›å»ºGradioç•Œé¢"""
    app = ASRGradioApp()
    
    with gr.Blocks(title="ASR Tools - è¯­éŸ³è¯†åˆ«å·¥å…·", theme=gr.themes.Soft()) as demo:
        gr.Markdown("""
        # ğŸ¤ ASR Tools - æ™ºèƒ½è¯­éŸ³è¯†åˆ«å·¥å…·
        
        åŸºäºå¿…å‰ªASRæ¥å£çš„é«˜æ•ˆè¯­éŸ³è¯†åˆ«å·¥å…·ï¼Œæ”¯æŒå¤šç§éŸ³é¢‘/è§†é¢‘æ ¼å¼å’Œè¾“å‡ºæ ¼å¼ã€‚
        """)
        
        with gr.Row():
            with gr.Column():
                file_input = gr.File(
                    label="é€‰æ‹©éŸ³é¢‘/è§†é¢‘æ–‡ä»¶",
                    file_count="multiple",
                    file_types=app.supported_formats
                )
                
                output_format = gr.Dropdown(
                    choices=["SRT", "TXT", "ASS"],
                    label="è¾“å‡ºæ ¼å¼",
                    value="SRT",
                    info="é€‰æ‹©å­—å¹•è¾“å‡ºæ ¼å¼"
                )
                
                process_btn = gr.Button("å¼€å§‹å¤„ç†", variant="primary")
            
            with gr.Column():
                output_text = gr.Textbox(
                    label="å¤„ç†ç»“æœ",
                    lines=10,
                    max_lines=20,
                    placeholder="å¤„ç†ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."
                )
                
                download_file = gr.File(
                    label="ä¸‹è½½ç”Ÿæˆçš„æ–‡ä»¶"
                )
        

        # å¤„ç†é€»è¾‘
        def process_files(files, format_choice):
            if not files:
                return "è¯·å…ˆé€‰æ‹©æ–‡ä»¶", None
            
            file_paths = [file.name for file in files]
            
            if len(file_paths) == 1:
                result, file_path = app.process_single_file(file_paths[0], format_choice)
                return result, file_path
            else:
                result = app.process_multiple_files(file_paths, format_choice)
                return result, None
        
        process_btn.click(
            fn=process_files,
            inputs=[file_input, output_format],
            outputs=[output_text, download_file]
        )
    
    return demo

if __name__ == "__main__":
    # åˆ›å»ºå¹¶å¯åŠ¨ç•Œé¢
    demo = create_interface()
    demo.launch(
        server_name="0.0.0.0",
        server_port=8080,
        share=False,
        show_error=True,
        debug=True
    )
